import io
import os
import json
import uuid
import base64
import pathlib
import requests
from django.http import HttpResponse, HttpResponseRedirect, FileResponse
from django.shortcuts import render
from django.contrib.auth.decorators import login_required
from django.conf import settings as _settings
from django.views.decorators.csrf import csrf_exempt

# Importation du modèle
from .models import GithubRun

@csrf_exempt 
@login_required(login_url='/api/user_action?action=login')
def generator_view(request):
    from .forms import GenerateForm
    if request.method == 'POST':
        form = GenerateForm(request.POST, request.FILES)
        if form.is_valid():
            # 1. Extraction des données
            platform = form.cleaned_data['platform']
            version = form.cleaned_data['version']
            server = form.cleaned_data['serverIP'] or 'rs-ny.rustdesk.com'
            key = form.cleaned_data['key'] or 'OeVuKk5nlHiXp+APNn0Y3pC1Iwpwn44JGqrQCsWqmBw='
            
            # --- FIX POUR GITHUB & NGROK ---
            if "ngrok" in request.get_host():
                full_url = f"https://{request.get_host()}"
            else:
                full_url = getattr(_settings, 'NGROK_URL', f"http://{request.get_host()}")

            apiServer = form.cleaned_data['apiServer'] or full_url
            appname = form.cleaned_data['appname'] or 'rustdesk'
            filename = form.cleaned_data['exename'] or 'rustdesk'
            
            myuuid = str(uuid.uuid4())
            
            # --- Sauvegarde Icône/Logo ---
            iconlink = "false"
            if request.FILES.get('iconfile'):
                iconlink = save_png_file(request.FILES.get('iconfile'), myuuid, full_url, "icon.png")

            # --- Configuration JSON ---
            custom_obj = {
                'override-settings': {'host': server, 'key': key, 'api-server': apiServer},
                'default-settings': {}
            }
            custom_json = json.dumps(custom_obj)

            # --- Extras pour le YAML ---
            extras_data = {
                'version': version,
                'rdgen': 'false',
                'token': _settings.GHBEARER,
                'compname': 'MyCompany',
                'urlLink': 'https://rustdesk.com',
                'downloadLink': 'https://rustdesk.com/download'
            }
            extras_json = json.dumps(extras_data)

            # --- Envoi GitHub ---
            # CORRECTION ICI : Ajout de la gestion macOS
            workflow = "generator-windows.yml"
            if platform == 'linux': 
                workflow = "generator-linux.yml"
            elif platform == 'android': 
                workflow = "generator-android.yml"
            elif platform in ['mac', 'macos', 'darwin']: # Condition ajoutée pour Mac
                workflow = "generator-macos.yml"

            url = f"https://api.github.com/repos/{_settings.GHUSER}/{_settings.REPONAME}/actions/workflows/{workflow}/dispatches"
            
            data = {
                "ref": "master", 
                "inputs": {
                    "server": server, "key": key, "apiServer": apiServer,
                    "custom": custom_json, "uuid": myuuid, "appname": appname,
                    "filename": filename, "extras": extras_json,
                    "iconlink": iconlink, "logolink": "false"
                }
            }
            
            headers = {
                'Accept': 'application/vnd.github+json',
                'Authorization': f'Bearer {_settings.GHBEARER}',
                'X-GitHub-Api-Version': '2022-11-28'
            }

            GithubRun.objects.create(uuid=myuuid, status="Starting...", name=filename, platform=platform)
            
            try:
                res = requests.post(url, json=data, headers=headers)
                print(f"STATUS GITHUB: {res.status_code}")
            except Exception as e:
                print(f"ERREUR RÉSEAU: {e}")
            
            return HttpResponseRedirect('/api/clients')
    else:
        form = GenerateForm()

    ua = request.META.get('HTTP_USER_AGENT', '')
    is_mobile = any(x in ua for x in ['Mobile', 'Android', 'iPhone'])
    phone_or_desktop = 'base_phone.html' if is_mobile else 'base.html'

    return render(request, 'generator.html', {
        'form': form,
        'phone_or_desktop': phone_or_desktop
    })

# --- FONCTIONS SUPPORTS ---

def get_png(request):
    filename = request.GET.get('filename')
    uuid_val = request.GET.get('uuid')
    file_path = os.path.join('png', uuid_val, filename)
    if os.path.exists(file_path):
        return FileResponse(open(file_path, 'rb'), content_type='image/png')
    return HttpResponse("Not Found", status=404)

@csrf_exempt
def save_custom_client(request):
    if request.method == 'POST' and 'file' in request.FILES:
        file = request.FILES['file']
        my_uuid = request.POST.get('uuid') or "default"
        path = pathlib.Path(f"exe/{my_uuid}")
        path.mkdir(parents=True, exist_ok=True)
        with open(path / file.name, 'wb+') as dest:
            for chunk in file.chunks():
                dest.write(chunk)
        return HttpResponse("Fichier sauvegardé")
    return HttpResponse("Erreur", status=400)

@csrf_exempt
def update_github_run(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            GithubRun.objects.filter(uuid=data.get('uuid')).update(status=data.get('status'))
        except:
            pass
    return HttpResponse('OK')

@csrf_exempt
def create_github_run(request):
    return update_github_run(request)

@login_required(login_url='/api/user_action?action=login')
def check_for_file(request):
    uuid = request.GET.get('uuid')
    gh_run = GithubRun.objects.filter(uuid=uuid).first()
    return render(request, 'waiting.html', {
        'status': gh_run.status if gh_run else "Unknown",
        'uuid': uuid
    })

@login_required(login_url='/api/user_action?action=login')
def download_client(request):
    filename = request.GET.get('filename')
    uuid = request.GET.get('uuid')
    file_path = os.path.join('exe', uuid, filename)
    if os.path.exists(file_path):
        with open(file_path, 'rb') as f:
            return HttpResponse(f.read(), content_type='application/octet-stream')
    return HttpResponse("File not found", status=404)

@login_required(login_url='/api/user_action?action=login')
def delete_pending(request):
    run_id = request.GET.get('id')
    if run_id:
        GithubRun.objects.filter(id=run_id).delete()
    return HttpResponseRedirect('/api/clients')

def save_png_file(file, uuid_val, domain, name):
    path = pathlib.Path(f"png/{uuid_val}")
    path.mkdir(parents=True, exist_ok=True)
    with open(path / name, 'wb+') as dest:
        for chunk in file.chunks():
            dest.write(chunk)
    return json.dumps({'url': f"{domain}/api/get_png", 'uuid': uuid_val, 'file': name})
