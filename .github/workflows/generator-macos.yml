name: Custom macOS Client Generator
run-name: Custom macOS Client Generator

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'version to build'
        required: true
        default: '1.3.1'
        type: string
      zip_url:
        description: 'url to zip of json'
        required: true
        default: ''
        type: string

env:
  SCITER_RUST_VERSION: "1.75"
  RUST_VERSION: "1.75"
  MAC_RUST_VERSION: "1.81"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  MACOS_P12_BASE64: "${{ secrets.MACOS_P12_BASE64 }}"
  # VCPKG_ROOT doit être défini ici pour être vu par tous les steps
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  # URL par défaut (sera écrasée par le script)
  STATUS_URL: "https://ultramicroscopical-nontemperately-dominick.ngrok-free.dev/api/updategh"

jobs:
  generate-bridge:
    uses: ./.github/workflows/bridge.yml
    with:
      version: ${{ inputs.version }}

  build-for-macos:
    name: Build ${{ matrix.job.arch }}
    needs: [generate-bridge]
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
          # --- INTEL (x86_64) ---
          # OBLIGATOIRE: macos-12 est le seul stable pour Intel actuellement.
          - {
              target: x86_64-apple-darwin,
              os: macos-12,
              extra-build-args: "",
              arch: x86_64,
              vcpkg-triplet: x64-osx,
            }
          # --- SILICON (ARM64) ---
          # OBLIGATOIRE: macos-14 pour M1/M2
          - {
              target: aarch64-apple-darwin,
              os: macos-14,
              extra-build-args: "--screencapturekit --hwcodec",
              arch: aarch64,
              vcpkg-triplet: arm64-osx,
            }

    steps:
      - name: Install Python deps
        run: |
          pip install requests pyzipper

      # --- RÉCUPÉRATION SECRETS (VOTRE SCRIPT) ---
      - name: Download, Decrypt, and Mask
        shell: python
        run: |
          import requests
          import pyzipper
          import io
          import os
          import json
          import sys

          # Gestion robuste de l'input API
          raw_input = '${{ inputs.zip_url }}'
          target_url = ""
          target_file = ""

          try:
              if '{' in raw_input:
                  data = json.loads(raw_input)
                  target_url = data.get('url')
                  target_file = data.get('file')
                  full_url = f"{target_url}/get_zip?filename={target_file}"
              else:
                  full_url = raw_input

              if not full_url:
                  print("No URL provided, skipping.")
                  sys.exit(0)

              print(f"Downloading from: {full_url}")
              r = requests.get(full_url)
              r.raise_for_status()

              with pyzipper.AESZipFile(io.BytesIO(r.content)) as zf:
                  zf.setpassword('${{ secrets.ZIP_PASSWORD }}'.encode())
                  with zf.open('secrets.json') as f:
                      secrets = json.load(f)

              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  for key, value in secrets.items():
                      print(f"::add-mask::{value}")
                      env_file.write(f"{key}={value}\n")
                  
                  # Gestion URL statut
                  api_server = secrets.get('apiServer', '').strip().rstrip('/')
                  if api_server:
                      env_file.write(f"STATUS_URL={api_server}/api/updategh\n")
                  
                  # Variables critiques pour la suite
                  env_file.write(f"appname={secrets.get('appname', 'RustDesk')}\n")
                  env_file.write(f"filename={secrets.get('filename', 'RustDesk')}\n")

          except Exception as e:
              print(f"Error in Python script: {e}")
              # On laisse continuer pour voir les logs, sinon exit(1)

      - name: Report Status Start
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Starting Build (${{ matrix.job.arch }})..."}'

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          ref: master
          submodules: recursive

      - name: Install Dependencies (Brew)
        run: |
          brew update
          brew install imagemagick potrace nasm
